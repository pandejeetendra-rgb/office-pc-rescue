<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Office PC Rescue ‚Äî Escape Room (Option B)</title>
<style>
  :root{
    --bg0:#070b16;
    --bg1:#0b1430;
    --panel: rgba(255,255,255,.07);
    --panel2: rgba(0,0,0,.25);
    --line: rgba(255,255,255,.12);
    --ink:#eaf0ff;
    --muted:#a9b6d6;

    --blue:#4aa3ff;
    --green:#3ddc97;
    --amber:#ffcc66;
    --red:#ff5c6c;

    --shadow: 0 18px 48px rgba(0,0,0,.45);
    --r:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    color:var(--ink);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:
      radial-gradient(1100px 700px at 15% 10%, rgba(74,163,255,.18), transparent 55%),
      radial-gradient(900px 600px at 80% 18%, rgba(61,220,151,.12), transparent 60%),
      radial-gradient(900px 600px at 75% 88%, rgba(255,92,108,.10), transparent 60%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    overflow-x:hidden;
  }

  /* ---------- Top bar ---------- */
  .wrap{max-width:1180px;margin:0 auto;padding:18px}
  .topbar{
    display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;
    padding:14px 14px;
    border:1px solid var(--line);
    border-radius: var(--r);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    box-shadow: var(--shadow);
    backdrop-filter: blur(8px);
  }
  .brand{display:flex;align-items:center;gap:10px}
  .logo{
    width:38px;height:38px;border-radius:12px;
    background:
      radial-gradient(circle at 30% 30%, rgba(74,163,255,.9), rgba(74,163,255,.20) 60%, rgba(0,0,0,0)),
      radial-gradient(circle at 70% 80%, rgba(61,220,151,.45), transparent 55%);
    border:1px solid rgba(74,163,255,.35);
    box-shadow: 0 0 0 6px rgba(74,163,255,.08);
  }
  .title{line-height:1.15}
  .title h1{margin:0;font-size:15px;font-weight:900;letter-spacing:.2px}
  .title p{margin:2px 0 0;font-size:12px;color:var(--muted)}
  .chips{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
  .chip{
    display:inline-flex;gap:8px;align-items:center;
    padding:7px 10px;border-radius:999px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.05);
    color:var(--muted);
    font-size:12px;
    white-space:nowrap;
  }
  .chip b{color:var(--ink)}
  .dots{display:flex;gap:6px}
  .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.10)}
  .dot.on{background: rgba(61,220,151,.95); border-color: rgba(61,220,151,.35); box-shadow:0 0 0 5px rgba(61,220,151,.10)}
  .clock{font-variant-numeric: tabular-nums; font-weight:900; color:var(--ink)}
  .btnTop{
    padding:8px 12px;border-radius:14px;border:1px solid var(--line);
    background: rgba(74,163,255,.14);
    color:var(--ink);
    font-weight:900;
    cursor:pointer;
  }
  .btnTop:hover{border-color: rgba(74,163,255,.40)}

  /* ---------- Main stage ---------- */
  .stage{margin-top:16px;display:grid;grid-template-columns: 1.35fr .65fr;gap:14px}
  @media (max-width: 980px){ .stage{grid-template-columns:1fr} }

  .panel{
    border:1px solid var(--line);
    border-radius: var(--r);
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    box-shadow: var(--shadow);
    overflow:hidden;
    position:relative;
    min-height: 560px;
  }
  .head{
    padding:12px 14px;border-bottom:1px solid var(--line);
    background: rgba(0,0,0,.22);
    display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
  }
  .head .h{font-weight:950;font-size:13px}
  .head .s{color:var(--muted);font-size:12px}

  /* ---------- Desktop Map ---------- */
  .desktop{
    position:relative;
    min-height: 520px;
    padding:14px;
    overflow:hidden;
  }
  .wallpaper{
    position:absolute;inset:0;
    background:
      radial-gradient(700px 520px at 30% 25%, rgba(74,163,255,.14), transparent 60%),
      radial-gradient(620px 520px at 78% 75%, rgba(61,220,151,.10), transparent 60%),
      radial-gradient(520px 420px at 80% 20%, rgba(255,204,102,.09), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.18));
    pointer-events:none;
  }
  .gridNoise{
    position:absolute;inset:0;
    background-image:
      linear-gradient(rgba(255,255,255,.035) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,.035) 1px, transparent 1px);
    background-size: 34px 34px;
    opacity:.35;
    pointer-events:none;
    mask-image: radial-gradient(600px 420px at 45% 35%, black 35%, transparent 70%);
  }

  .taskbar{
    position:absolute;left:14px;right:14px;bottom:14px;
    height:54px;
    border-radius:18px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.28);
    display:flex;align-items:center;justify-content:space-between;
    padding:10px 12px;
    backdrop-filter: blur(8px);
  }
  .tbLeft{display:flex;gap:10px;align-items:center}
  .tbIcon{
    width:34px;height:34px;border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
    display:grid;place-items:center;
    color:var(--muted);
  }
  .tbRight{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px}
  .wifiPill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04)}

  /* Lock overlay */
  .lockOverlay{
    position:absolute;inset:0;
    display:none;
    place-items:center;
    background: radial-gradient(900px 560px at 40% 20%, rgba(255,92,108,.13), transparent 60%),
                rgba(0,0,0,.60);
    backdrop-filter: blur(10px);
    z-index: 5;
  }
  .lockOverlay.show{display:grid}
  .lockCard{
    width:min(520px, 92%);
    border-radius:24px;
    border:1px solid rgba(255,92,108,.25);
    background: linear-gradient(180deg, rgba(255,92,108,.10), rgba(0,0,0,.35));
    box-shadow: var(--shadow);
    padding:16px;
    position:relative;
    overflow:hidden;
  }
  .lockCard .big{
    font-weight:950;font-size:16px;
    display:flex;align-items:center;gap:10px;
  }
  .lockCard p{margin:10px 0 0;color:var(--muted);font-size:13px;line-height:1.45}
  .lockRing{
    position:absolute;inset:auto -70px -70px auto;
    width:220px;height:220px;border-radius:999px;
    background: radial-gradient(circle at 35% 35%, rgba(255,92,108,.25), transparent 62%);
    pointer-events:none;
  }

  /* Nodes */
  .node{
    position:absolute;
    width:160px;
    border-radius:18px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.22);
    padding:12px;
    cursor:pointer;
    transition: transform .15s ease, border-color .25s ease, box-shadow .25s ease, opacity .25s ease;
    user-select:none;
  }
  .node:hover{transform: translateY(-2px); border-color: rgba(255,255,255,.22)}
  .node.locked{opacity:.55; cursor:not-allowed}
  .node.active{
    outline: 2px solid rgba(74,163,255,.55);
    box-shadow: 0 0 0 10px rgba(74,163,255,.10);
  }
  .node .top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
  .node .nm{font-weight:950;font-size:13px}
  .node .ds{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.3}
  .pill{
    padding:6px 10px;border-radius:999px;border:1px solid var(--line);
    background: rgba(255,255,255,.04);
    color:var(--muted);
    font-size:11px;white-space:nowrap;
    display:inline-flex;gap:6px;align-items:center;
  }
  .led{width:9px;height:9px;border-radius:999px;background: rgba(255,255,255,.12)}
  .node[data-state="red"] .led{background: rgba(255,92,108,.95)}
  .node[data-state="amber"] .led{background: rgba(255,204,102,.95)}
  .node[data-state="green"] .led{background: rgba(61,220,151,.95)}
  .glowNode{
    position:absolute;inset:-30px -30px auto auto;
    width:120px;height:120px;border-radius:999px;
    background: radial-gradient(circle at 30% 30%, rgba(74,163,255,.16), transparent 68%);
    pointer-events:none;
  }

  /* Connectors */
  .wire{
    position:absolute;
    height:3px;
    background: linear-gradient(90deg, rgba(74,163,255,.18), rgba(255,255,255,.06));
    border-radius:999px;
    opacity:.7;
    transform-origin:left center;
    pointer-events:none;
  }
  .spark{
    position:absolute;
    width:10px;height:10px;border-radius:999px;
    background: rgba(74,163,255,.9);
    box-shadow: 0 0 0 8px rgba(74,163,255,.10);
    opacity:0;
    pointer-events:none;
  }
  .spark.go{
    animation: sparkMove 1.2s ease forwards;
    opacity:1;
  }
  @keyframes sparkMove{
    0%{transform: translate(0,0) scale(.9); opacity:0}
    12%{opacity:1}
    100%{transform: translate(var(--dx), var(--dy)) scale(1); opacity:0}
  }

  /* ---------- Sidebar ---------- */
  .side{
    display:flex;
    flex-direction:column;
    min-height: 560px;
  }
  .sideBody{padding:14px;display:flex;flex-direction:column;gap:12px;min-height: 520px}
  .card{
    border-radius:18px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.22);
    padding:12px;
  }
  .card .t{font-weight:950;font-size:13px;display:flex;align-items:center;gap:8px}
  .card .p{margin-top:6px;color:var(--muted);font-size:12.5px;line-height:1.45}
  .keyring{
    display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;
  }
  .keyFrag{
    width:46px;height:46px;border-radius:16px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.04);
    display:grid;place-items:center;
    font-weight:950;color:var(--muted);
    position:relative;
    overflow:hidden;
  }
  .keyFrag.on{
    border-color: rgba(61,220,151,.30);
    background: rgba(61,220,151,.08);
    color: rgba(61,220,151,.95);
    box-shadow: 0 0 0 8px rgba(61,220,151,.08);
  }
  .keyFrag.on::after{
    content:"";
    position:absolute;inset:-30px -30px auto auto;
    width:80px;height:80px;border-radius:999px;
    background: radial-gradient(circle at 30% 30%, rgba(61,220,151,.20), transparent 65%);
  }

  .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
  .btn{
    border-radius:14px;
    padding:10px 12px;
    border:1px solid var(--line);
    background: rgba(74,163,255,.14);
    color:var(--ink);
    font-weight:950;
    cursor:pointer;
  }
  .btn:hover{border-color: rgba(74,163,255,.40)}
  .btn.ghost{background: rgba(255,255,255,.04)}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .hint{color:var(--muted);font-size:12px}

  /* ---------- Modal: Station ---------- */
  .modalWrap{
    position:fixed;inset:0;
    display:none;
    place-items:center;
    padding:16px;
    background: rgba(0,0,0,.62);
    backdrop-filter: blur(10px);
    z-index: 50;
  }
  .modalWrap.show{display:grid}
  .modal{
    width:min(900px, 100%);
    border-radius:24px;
    border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.03));
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .modalHead{
    padding:12px 14px;
    border-bottom:1px solid var(--line);
    background: rgba(0,0,0,.22);
    display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
  }
  .modalHead .mh{font-weight:950}
  .modalHead .ms{color:var(--muted);font-size:12px}
  .modalBody{
    padding:14px;
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap:12px;
  }
  @media (max-width: 860px){ .modalBody{grid-template-columns:1fr} }

  .mock{
    border-radius:20px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.25);
    padding:14px;
    position:relative;
    overflow:hidden;
    min-height: 280px;
  }
  .mockTop{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:10px 10px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
  }
  .mockTop b{font-weight:950}
  .mockPanel{
    margin-top:12px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  .miniTile{
    border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    padding:10px;
  }
  .miniTile .k{font-weight:950;font-size:12.5px}
  .miniTile .v{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.35}

  .pulse{
    position:absolute;inset:-60px;
    background: radial-gradient(520px 280px at 35% 25%, rgba(74,163,255,.13), transparent 60%);
    pointer-events:none;
  }
  .pulse.good{background: radial-gradient(520px 280px at 35% 25%, rgba(61,220,151,.12), transparent 60%)}
  .pulse.bad{background: radial-gradient(520px 280px at 35% 25%, rgba(255,92,108,.12), transparent 60%)}

  .quiz{
    border-radius:20px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.25);
    padding:14px;
  }
  .quiz .q{font-weight:950;font-size:13px;line-height:1.4}
  .opts{display:grid;gap:10px;margin-top:12px}
  .opt{
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    padding:10px 12px;
    display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    cursor:pointer;
    transition: transform .12s ease, border-color .22s ease, background .22s ease;
  }
  .opt:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.20)}
  .opt:disabled{opacity:.55;cursor:not-allowed}
  .opt .l{display:flex;gap:10px;align-items:flex-start}
  .ico{
    width:28px;height:28px;border-radius:10px;
    border:1px solid rgba(74,163,255,.22);
    background: rgba(74,163,255,.12);
    display:grid;place-items:center;
    flex:0 0 auto;
  }
  .kbd{
    padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.28);
    color:var(--muted);
    font-size:11px;white-space:nowrap;
  }
  .fb{
    margin-top:12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.25);
    padding:12px;
    display:none;
  }
  .fb.show{display:block}
  .fb.good{border-color: rgba(61,220,151,.25); background: linear-gradient(180deg, rgba(61,220,151,.10), rgba(0,0,0,.25))}
  .fb.bad{border-color: rgba(255,92,108,.25); background: linear-gradient(180deg, rgba(255,92,108,.10), rgba(0,0,0,.25))}
  .fb .t{font-weight:950}
  .fb .p{margin-top:6px;color:var(--muted);font-size:12.5px;line-height:1.45}

  /* ---------- End modal ---------- */
  .endGrid{
    display:grid;gap:10px;margin-top:12px
  }
  .rowOk{
    border-radius:16px;
    border:1px solid rgba(61,220,151,.25);
    background: rgba(61,220,151,.08);
    padding:10px 12px;
    display:flex;align-items:center;justify-content:space-between;gap:10px;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce){
    *{transition:none !important; animation:none !important}
  }
</style>
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="title">
        <h1>Office PC Rescue ‚Äî Escape Room</h1>
        <p>Unlock the secured desktop by fixing 5 Windows security stations</p>
      </div>
    </div>

    <div class="chips">
      <div class="chip">üîë Keys: <b id="keysText">0</b>/5</div>
      <div class="chip">üü© Progress <b id="progText">0%</b></div>
      <div class="chip">üßë‚Äçüíª Shift <span class="clock" id="clock">--:--</span></div>
      <button class="btnTop" id="resetTop" type="button">Reset</button>
    </div>
  </div>

  <div class="stage">
    <!-- Desktop Map -->
    <div class="panel">
      <div class="head">
        <div>
          <div class="h">Desktop Map</div>
          <div class="s" id="subline">Complete stations in order. Each station gives a key fragment.</div>
        </div>
        <div class="chip">Wi-Fi: <b>Office_Guest</b> ¬∑ Mode: <b>Escape</b></div>
      </div>

      <div class="desktop" id="desktop">
        <div class="wallpaper"></div>
        <div class="gridNoise"></div>

        <!-- Connectors (simple wires) -->
        <div class="wire" id="w1"></div>
        <div class="wire" id="w2"></div>
        <div class="wire" id="w3"></div>
        <div class="wire" id="w4"></div>
        <div class="spark" id="spark"></div>

        <!-- Nodes -->
        <div class="node" id="n1" data-key="accounts" data-state="red" style="left:18px; top:18px;">
          <div class="glowNode"></div>
          <div class="top">
            <div>
              <div class="nm">üë§ Accounts</div>
              <div class="ds">Fix shared login & sign-in safety</div>
            </div>
            <div class="pill"><span class="led"></span><span class="st">Locked</span></div>
          </div>
        </div>

        <div class="node locked" id="n2" data-key="lock" data-state="red" style="right:18px; top:58px;">
          <div class="glowNode"></div>
          <div class="top">
            <div>
              <div class="nm">üîí Screen Lock</div>
              <div class="ds">Auto-lock & sign-in on resume</div>
            </div>
            <div class="pill"><span class="led"></span><span class="st">Locked</span></div>
          </div>
        </div>

        <div class="node locked" id="n3" data-key="updates" data-state="red" style="left:70px; bottom:120px;">
          <div class="glowNode"></div>
          <div class="top">
            <div>
              <div class="nm">üîÑ Updates</div>
              <div class="ds">Patch the OS safely (active hours)</div>
            </div>
            <div class="pill"><span class="led"></span><span class="st">Locked</span></div>
          </div>
        </div>

        <div class="node locked" id="n4" data-key="firewall" data-state="red" style="right:80px; bottom:170px;">
          <div class="glowNode"></div>
          <div class="top">
            <div>
              <div class="nm">üõ°Ô∏è Firewall</div>
              <div class="ds">Secure public/private network profiles</div>
            </div>
            <div class="pill"><span class="led"></span><span class="st">Locked</span></div>
          </div>
        </div>

        <div class="node locked" id="n5" data-key="privacy" data-state="red" style="left:280px; top:210px; width:190px;">
          <div class="glowNode"></div>
          <div class="top">
            <div>
              <div class="nm">üëÅÔ∏è Privacy</div>
              <div class="ds">App permissions & diagnostic settings</div>
            </div>
            <div class="pill"><span class="led"></span><span class="st">Locked</span></div>
          </div>
        </div>

        <div class="taskbar">
          <div class="tbLeft">
            <div class="tbIcon">‚äû</div>
            <div class="tbIcon">‚öô</div>
            <div class="tbIcon">üõ°</div>
            <div class="tbIcon">üîç</div>
          </div>
          <div class="tbRight">
            <span class="wifiPill">üîí Secure Desktop</span>
            <span class="wifiPill">üîî <span id="notif">5</span></span>
          </div>
        </div>

        <!-- Lock overlay -->
        <div class="lockOverlay show" id="lockOverlay">
          <div class="lockCard">
            <div class="lockRing"></div>
            <div class="big">üîê PC Locked</div>
            <p>
              This office PC cannot be used safely until core Windows security settings are restored.
              Complete all 5 stations to unlock the desktop.
            </p>
            <div class="btnRow" style="margin-top:12px">
              <button class="btn" id="beginBtn" type="button">Begin</button>
              <button class="btn ghost" id="howBtn" type="button">How to play</button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Sidebar -->
    <div class="panel side">
      <div class="head">
        <div>
          <div class="h">Security Keyring</div>
          <div class="s">Each station unlock gives one key fragment</div>
        </div>
        <div class="chip">Goal: <b>Unlock Desktop</b></div>
      </div>

      <div class="sideBody">
        <div class="card">
          <div class="t">üìå Mission</div>
          <div class="p" id="missionText">
            Start with <b>Accounts</b>. Each station becomes available after the previous one is secured.
          </div>
          <div class="keyring" id="keyring">
            <div class="keyFrag" id="k1">1</div>
            <div class="keyFrag" id="k2">2</div>
            <div class="keyFrag" id="k3">3</div>
            <div class="keyFrag" id="k4">4</div>
            <div class="keyFrag" id="k5">5</div>
          </div>
        </div>

        <div class="card">
          <div class="t">üß† How to win</div>
          <div class="p">
            In each station, answer <b>2 correct</b> questions to secure the station and obtain its key fragment.
            Options are shuffled automatically, so no pattern guessing.
          </div>
          <div class="hint" style="margin-top:10px">
            Tip: Make decisions like real IT support: authentication first, then protection, then privacy hardening.
          </div>
        </div>

        <div class="card">
          <div class="t">‚öô Controls</div>
          <div class="p">
            Click a station node to enter. Use keyboard <b>1‚Äì4</b> to answer options faster.
          </div>
          <div class="btnRow">
            <button class="btn ghost" id="resetBtn" type="button">Reset Game</button>
          </div>
        </div>

        <div class="card" id="statusCard">
          <div class="t">üì∂ Status</div>
          <div class="p" id="statusText">Locked. Begin to start.</div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Station Modal -->
<div class="modalWrap" id="stationModal" aria-hidden="true">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="mh" id="mTitle">Station</div>
        <div class="ms" id="mSub">Complete 2 correct to secure this station</div>
      </div>
      <div class="chip">Correct: <b id="mCount">0</b>/2</div>
    </div>

    <div class="modalBody">
      <div class="mock">
        <div class="pulse" id="pulse"></div>
        <div class="mockTop">
          <div>‚öô <b id="mockName">Windows Settings</b></div>
          <div class="chip">Path: <b id="mockPath">Settings</b></div>
        </div>
        <div class="mockPanel">
          <div class="miniTile">
            <div class="k" id="a1k">Status</div>
            <div class="v" id="a1v">Needs attention</div>
          </div>
          <div class="miniTile">
            <div class="k" id="a2k">Recommended</div>
            <div class="v" id="a2v">Apply the safest first action</div>
          </div>
          <div class="miniTile">
            <div class="k" id="a3k">Impact</div>
            <div class="v" id="a3v">Reduces exposure and prevents misuse</div>
          </div>
          <div class="miniTile">
            <div class="k" id="a4k">Hint</div>
            <div class="v" id="a4v">Think of least privilege and safe defaults</div>
          </div>
        </div>
      </div>

      <div class="quiz">
        <div class="q" id="qText">Question</div>
        <div class="opts" id="opts"></div>

        <div class="fb" id="fb">
          <div class="t" id="fbT">‚Äî</div>
          <div class="p" id="fbP">‚Äî</div>
          <div class="btnRow" style="margin-top:10px">
            <button class="btn" id="nextBtn" type="button">Next</button>
            <button class="btn ghost" id="closeStationBtn" type="button">Close</button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- How to play modal -->
<div class="modalWrap" id="howModal">
  <div class="modal">
    <div class="modalHead">
      <div class="mh">How to play</div>
      <div class="chip">Escape Room Mode</div>
    </div>
    <div class="modalBody" style="grid-template-columns:1fr">
      <div style="padding:2px 2px 10px">
        <div style="font-weight:950;font-size:14px">Rules</div>
        <ul style="margin:10px 0 0;padding-left:18px;color:var(--muted);line-height:1.55;font-size:13px">
          <li>Stations must be completed in order.</li>
          <li>Each station requires <b>2 correct</b> answers (questions are scenario-based).</li>
          <li>After completion, the station turns green and a key fragment is added to your keyring.</li>
          <li>After 5 keys, the lock overlay disappears and the desktop becomes secured.</li>
          <li>Options are shuffled each time you see a question.</li>
        </ul>
        <div class="btnRow" style="margin-top:14px">
          <button class="btn" id="closeHowBtn" type="button">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- End modal -->
<div class="modalWrap" id="endModal">
  <div class="modal">
    <div class="modalHead">
      <div class="mh">Desktop Unlocked</div>
      <div class="chip">Keys <b>5/5</b></div>
    </div>
    <div class="modalBody" style="grid-template-columns:1fr">
      <div style="padding:2px 2px 10px">
        <div style="font-weight:950;font-size:14px">System status</div>
        <div style="margin-top:6px;color:var(--muted);font-size:13px;line-height:1.55">
          You restored baseline Windows security. The office desktop is now safe to use.
        </div>
        <div class="endGrid" id="endGrid"></div>
        <div class="btnRow" style="margin-top:14px">
          <button class="btn" id="playAgainBtn" type="button">Play again</button>
          <button class="btn ghost" id="closeEndBtn" type="button">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   Office PC Rescue ‚Äî Escape Room (Option B)
   - 5 stations, sequential unlocking
   - Each station needs 2 correct
   - Options shuffled every question (no ‚Äúfirst option correct‚Äù pattern)
   - Smooth UI, no flicker, mobile-friendly
========================================================= */

/* --------- Station definitions --------- */
const STATIONS = [
  {
    key:"accounts", nodeId:"n1", keyId:"k1",
    title:"Accounts Security", icon:"üë§",
    subtitle:"Stop shared access and enforce safe sign-in",
    path:"Settings ‚Üí Accounts ‚Üí Sign-in options",
    facts:{
      status:"Shared/weak access patterns detected",
      recommended:"Separate users and enforce sign-in rules",
      impact:"Prevents misuse and improves accountability",
      hint:"Authentication is the first line of defense"
    }
  },
  {
    key:"lock", nodeId:"n2", keyId:"k2",
    title:"Screen Lock", icon:"üîí",
    subtitle:"Ensure the PC locks when unattended",
    path:"Settings ‚Üí Accounts ‚Üí Sign-in options / Screen saver",
    facts:{
      status:"PC remains unlocked after inactivity",
      recommended:"Auto-lock + require sign-in on resume",
      impact:"Stops walk-up misuse in shared spaces",
      hint:"Use short timeouts on shared computers"
    }
  },
  {
    key:"updates", nodeId:"n3", keyId:"k3",
    title:"Windows Updates", icon:"üîÑ",
    subtitle:"Patch vulnerabilities using safe defaults",
    path:"Settings ‚Üí Windows Update",
    facts:{
      status:"Updates are delayed/disabled",
      recommended:"Enable automatic updates + active hours",
      impact:"Reduces exposure to known vulnerabilities",
      hint:"Security patches matter more than convenience"
    }
  },
  {
    key:"firewall", nodeId:"n4", keyId:"k4",
    title:"Firewall Profiles", icon:"üõ°Ô∏è",
    subtitle:"Protect on public and private networks",
    path:"Windows Security ‚Üí Firewall & network protection",
    facts:{
      status:"Firewall protection is inconsistent",
      recommended:"Ensure firewall is ON across profiles",
      impact:"Reduces inbound attack surface on networks",
      hint:"Public Wi-Fi is higher risk"
    }
  },
  {
    key:"privacy", nodeId:"n5", keyId:"k5",
    title:"Privacy & Permissions", icon:"üëÅÔ∏è",
    subtitle:"Tighten camera/mic/app permissions",
    path:"Settings ‚Üí Privacy (or Privacy & security)",
    facts:{
      status:"Apps have unnecessary sensitive access",
      recommended:"Disable unneeded permissions and background access",
      impact:"Reduces data leakage and attack surface",
      hint:"Follow least privilege"
    }
  }
];

/* --------- Question bank (sample) ---------
   Replace these with your chapter-derived questions later.
   Keep structure:
   { stationKey, q, options:[{t, icon},...], correctIndex, ok, bad }
------------------------------------------- */
const QUESTION_BANK = [
  // ACCOUNTS
  { stationKey:"accounts",
    q:"Multiple staff members use one shared login. What is the best first step?",
    options:[
      {t:"Create separate user accounts and enforce passwords", icon:"üë§"},
      {t:"Keep one account and share the password in a group", icon:"üîë"},
      {t:"Disable sign-in to speed up access", icon:"‚ö°"},
      {t:"Write the password on a note near the monitor", icon:"üìù"}
    ],
    correctIndex:0,
    ok:"Separate accounts enable real access control and accountability.",
    bad:"Shared accounts remove accountability and increase exposure."
  },
  { stationKey:"accounts",
    q:"What is the safest habit for administrator access on an office PC?",
    options:[
      {t:"Use standard accounts daily and elevate only when needed", icon:"üßë‚Äçüíª"},
      {t:"Always stay logged in as Administrator", icon:"üëë"},
      {t:"Share admin password with all staff for convenience", icon:"üîì"},
      {t:"Disable UAC prompts so nothing interrupts work", icon:"üö´"}
    ],
    correctIndex:0,
    ok:"Least privilege reduces damage if something goes wrong.",
    bad:"Constant admin access increases risk and impact of mistakes."
  },
  { stationKey:"accounts",
    q:"The PC wakes from sleep without asking credentials. What should you do?",
    options:[
      {t:"Require sign-in when the PC wakes up (on resume)", icon:"üîí"},
      {t:"Disable the lock screen permanently", icon:"üö´"},
      {t:"Ignore it because it saves time", icon:"‚è≥"},
      {t:"Turn off sleep forever", icon:"üí°"}
    ],
    correctIndex:0,
    ok:"Sign-in on resume prevents walk-up access during breaks.",
    bad:"Unattended access remains a serious risk in shared environments."
  },

  // LOCK
  { stationKey:"lock",
    q:"Employees forget to lock the screen during breaks. Best practical control?",
    options:[
      {t:"Set a short inactivity timeout and require sign-in on resume", icon:"‚è≤Ô∏è"},
      {t:"Increase timeout so it rarely locks", icon:"üï∞Ô∏è"},
      {t:"Disable screen lock to reduce complaints", icon:"üö´"},
      {t:"Lock only at the end of the day", icon:"üåô"}
    ],
    correctIndex:0,
    ok:"Auto-lock reduces reliance on memory and habits.",
    bad:"Long or disabled locking increases chances of misuse."
  },
  { stationKey:"lock",
    q:"Which quick action is recommended when leaving the desk briefly?",
    options:[
      {t:"Manually lock the PC before stepping away", icon:"üîí"},
      {t:"Minimize windows only", icon:"ü™ü"},
      {t:"Turn brightness down to look ‚Äòoff‚Äô", icon:"üåó"},
      {t:"Close the lid without lock settings", icon:"üß≥"}
    ],
    correctIndex:0,
    ok:"Manual lock is instant and reliable.",
    bad:"Minimizing or dimming does not prevent access."
  },
  { stationKey:"lock",
    q:"What is the main reason for using a short lock timeout on shared PCs?",
    options:[
      {t:"It reduces walk-up access and opportunistic misuse", icon:"üõ°Ô∏è"},
      {t:"It makes the PC faster", icon:"‚ö°"},
      {t:"It increases storage space", icon:"üíæ"},
      {t:"It improves Wi-Fi strength", icon:"üì∂"}
    ],
    correctIndex:0,
    ok:"Short timeouts reduce exposure when someone forgets to lock.",
    bad:"The purpose is security, not performance or networking."
  },

  // UPDATES
  { stationKey:"updates",
    q:"Updates were disabled due to work disruption. Best first action?",
    options:[
      {t:"Enable automatic updates and set active hours", icon:"üîÑ"},
      {t:"Update only once a year", icon:"üìÜ"},
      {t:"Disable update notifications permanently", icon:"üîï"},
      {t:"Skip updates if antivirus is present", icon:"ü¶†"}
    ],
    correctIndex:0,
    ok:"Active hours keep updates practical while staying protected.",
    bad:"Delaying updates keeps known vulnerabilities open longer."
  },
  { stationKey:"updates",
    q:"Why are OS security updates important for office PCs?",
    options:[
      {t:"They patch known vulnerabilities used by attackers", icon:"ü©π"},
      {t:"They only change the look of Windows", icon:"üé®"},
      {t:"They reduce password requirements", icon:"üîì"},
      {t:"They make antivirus unnecessary", icon:"üö´"}
    ],
    correctIndex:0,
    ok:"Updates reduce exposure to known, documented issues.",
    bad:"Updates matter for security; they do not replace protections."
  },
  { stationKey:"updates",
    q:"What is a safe way to reduce interruptions without disabling updates?",
    options:[
      {t:"Schedule update times using active hours and restart options", icon:"‚è±Ô∏è"},
      {t:"Turn updates off and hope antivirus catches everything", icon:"üòê"},
      {t:"Block all update servers", icon:"üöß"},
      {t:"Ignore pending restarts indefinitely", icon:"‚è≥"}
    ],
    correctIndex:0,
    ok:"Scheduling keeps protection while respecting workflow.",
    bad:"Blocking or ignoring restarts increases risk over time."
  },

  // FIREWALL
  { stationKey:"firewall",
    q:"A laptop connects to public Wi-Fi. What should you verify first?",
    options:[
      {t:"Firewall is ON for both public and private profiles", icon:"üõ°Ô∏è"},
      {t:"Turn OFF firewall to improve speed", icon:"‚ö°"},
      {t:"Enable open file sharing for convenience", icon:"üìÇ"},
      {t:"Only change the desktop theme", icon:"üé®"}
    ],
    correctIndex:0,
    ok:"Firewall reduces unwanted inbound connections on risky networks.",
    bad:"Disabling firewall or opening sharing increases exposure."
  },
  { stationKey:"firewall",
    q:"Which statement about firewall profiles is most accurate?",
    options:[
      {t:"Public networks generally need stricter firewall settings", icon:"üì∂"},
      {t:"Public networks are safer than private networks", icon:"üòÑ"},
      {t:"Firewall only matters if malware is already present", icon:"ü¶†"},
      {t:"Firewall should be OFF in offices", icon:"üö´"}
    ],
    correctIndex:0,
    ok:"Public networks are higher risk; stricter controls are sensible.",
    bad:"Firewall is a baseline protection, not a last resort."
  },
  { stationKey:"firewall",
    q:"What is a sensible goal when configuring firewall on an office PC?",
    options:[
      {t:"Keep firewall enabled and allow only necessary apps", icon:"‚úÖ"},
      {t:"Disable firewall to avoid prompts", icon:"üîï"},
      {t:"Allow all inbound connections by default", icon:"üåä"},
      {t:"Use firewall only on weekends", icon:"üìÖ"}
    ],
    correctIndex:0,
    ok:"Default-deny + allow required apps is safer and manageable.",
    bad:"Over-permissive settings defeat the purpose of the firewall."
  },

  // PRIVACY
  { stationKey:"privacy",
    q:"Many apps have camera/mic access without clear need. Best first action?",
    options:[
      {t:"Review permissions and disable unnecessary access", icon:"üëÅÔ∏è"},
      {t:"Allow all permissions to avoid errors", icon:"‚úÖ"},
      {t:"Disable screen lock instead", icon:"üîì"},
      {t:"Share admin password so apps install easily", icon:"üîë"}
    ],
    correctIndex:0,
    ok:"Least-privilege permissions reduce privacy leakage and risk.",
    bad:"Unnecessary access increases exposure without improving security."
  },
  { stationKey:"privacy",
    q:"Which choice best reduces privacy exposure on shared PCs?",
    options:[
      {t:"Disable unneeded background app access and tracking", icon:"üß©"},
      {t:"Turn off updates to stop changes", icon:"üîÑ"},
      {t:"Disable firewall to reduce prompts", icon:"üõ°Ô∏è"},
      {t:"Ignore settings because defaults are always perfect", icon:"üòê"}
    ],
    correctIndex:0,
    ok:"Reducing background access and tracking lowers exposure.",
    bad:"Changing unrelated protections does not address privacy risk."
  },
  { stationKey:"privacy",
    q:"What principle should guide app permission decisions?",
    options:[
      {t:"Grant only what is needed (least privilege)", icon:"üéØ"},
      {t:"Grant everything once and never review", icon:"‚úÖ"},
      {t:"Permissions do not matter for security", icon:"üö´"},
      {t:"Always allow microphone for all apps", icon:"üéôÔ∏è"}
    ],
    correctIndex:0,
    ok:"Least privilege reduces attack surface and unwanted data access.",
    bad:"Over-permissioning increases risk and is hard to audit later."
  }
];

/* --------- Game state --------- */
const state = {
  started:false,
  currentIndex:0, // station index
  keys:0,
  stationCorrect:0,
  activeStationKey:null,
  usedQs: new Set(), // question IDs if you add ids later
};

const els = {
  keysText: document.getElementById("keysText"),
  progText: document.getElementById("progText"),
  clock: document.getElementById("clock"),
  notif: document.getElementById("notif"),
  subline: document.getElementById("subline"),
  missionText: document.getElementById("missionText"),
  statusText: document.getElementById("statusText"),

  lockOverlay: document.getElementById("lockOverlay"),
  beginBtn: document.getElementById("beginBtn"),
  howBtn: document.getElementById("howBtn"),
  howModal: document.getElementById("howModal"),
  closeHowBtn: document.getElementById("closeHowBtn"),

  resetBtn: document.getElementById("resetBtn"),
  resetTop: document.getElementById("resetTop"),

  stationModal: document.getElementById("stationModal"),
  mTitle: document.getElementById("mTitle"),
  mSub: document.getElementById("mSub"),
  mCount: document.getElementById("mCount"),

  mockName: document.getElementById("mockName"),
  mockPath: document.getElementById("mockPath"),
  a1k: document.getElementById("a1k"),
  a1v: document.getElementById("a1v"),
  a2k: document.getElementById("a2k"),
  a2v: document.getElementById("a2v"),
  a3k: document.getElementById("a3k"),
  a3v: document.getElementById("a3v"),
  a4k: document.getElementById("a4k"),
  a4v: document.getElementById("a4v"),
  pulse: document.getElementById("pulse"),

  qText: document.getElementById("qText"),
  opts: document.getElementById("opts"),
  fb: document.getElementById("fb"),
  fbT: document.getElementById("fbT"),
  fbP: document.getElementById("fbP"),
  nextBtn: document.getElementById("nextBtn"),
  closeStationBtn: document.getElementById("closeStationBtn"),

  keyEls: [
    document.getElementById("k1"),
    document.getElementById("k2"),
    document.getElementById("k3"),
    document.getElementById("k4"),
    document.getElementById("k5")
  ],

  nodes: {
    accounts: document.getElementById("n1"),
    lock: document.getElementById("n2"),
    updates: document.getElementById("n3"),
    firewall: document.getElementById("n4"),
    privacy: document.getElementById("n5"),
  },

  wires: [document.getElementById("w1"),document.getElementById("w2"),document.getElementById("w3"),document.getElementById("w4")],
  spark: document.getElementById("spark"),

  endModal: document.getElementById("endModal"),
  endGrid: document.getElementById("endGrid"),
  playAgainBtn: document.getElementById("playAgainBtn"),
  closeEndBtn: document.getElementById("closeEndBtn"),
};

function setClock(){
  const now = new Date();
  els.clock.textContent = String(now.getHours()).padStart(2,"0") + ":" + String(now.getMinutes()).padStart(2,"0");
}
setClock();
setInterval(setClock, 15000);

function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function setNodeState(stationKey, s){
  const n = els.nodes[stationKey];
  if(!n) return;
  n.dataset.state = s;
  const st = n.querySelector(".st");
  if(st) st.textContent = s==="green" ? "Secured" : (s==="amber" ? "In progress" : "Locked");
}

function setNodeLocked(stationKey, locked){
  const n = els.nodes[stationKey];
  if(!n) return;
  n.classList.toggle("locked", locked);
}

function setActiveNode(stationKey){
  Object.values(els.nodes).forEach(n => n.classList.remove("active"));
  const n = els.nodes[stationKey];
  if(n) n.classList.add("active");
}

/* Wire layout between nodes (purely decorative) */
function layoutWires(){
  const p = document.getElementById("desktop").getBoundingClientRect();
  const order = ["accounts","lock","privacy","updates","firewall"];
  const pts = order.map(k=>{
    const r = els.nodes[k].getBoundingClientRect();
    return { x:(r.left - p.left) + r.width/2, y:(r.top - p.top) + r.height/2 };
  });
  for(let i=0;i<4;i++){
    const a = pts[i], b = pts[i+1];
    const dx = b.x - a.x, dy = b.y - a.y;
    const len = Math.hypot(dx,dy);
    const ang = Math.atan2(dy,dx) * (180/Math.PI);
    const w = els.wires[i];
    w.style.left = a.x + "px";
    w.style.top  = a.y + "px";
    w.style.width = len + "px";
    w.style.transform = `rotate(${ang}deg)`;
  }
}
window.addEventListener("resize", ()=> setTimeout(layoutWires, 50));
setTimeout(layoutWires, 80);

/* Spark run along wires when station completes */
function runSpark(fromKey, toKey){
  const p = document.getElementById("desktop").getBoundingClientRect();
  const aR = els.nodes[fromKey].getBoundingClientRect();
  const bR = els.nodes[toKey].getBoundingClientRect();
  const ax = (aR.left - p.left) + aR.width/2;
  const ay = (aR.top - p.top) + aR.height/2;
  const bx = (bR.left - p.left) + bR.width/2;
  const by = (bR.top - p.top) + bR.height/2;
  els.spark.style.left = ax + "px";
  els.spark.style.top  = ay + "px";
  els.spark.style.setProperty("--dx", (bx-ax) + "px");
  els.spark.style.setProperty("--dy", (by-ay) + "px");
  els.spark.classList.remove("go");
  // force reflow
  void els.spark.offsetWidth;
  els.spark.classList.add("go");
}

/* Progress + keyring */
function updateTop(){
  els.keysText.textContent = String(state.keys);
  const pct = Math.round((state.keys/5)*100);
  els.progText.textContent = pct + "%";
  els.notif.textContent = String(Math.max(0, 5-state.keys));
  els.keyEls.forEach((k,i)=> k.classList.toggle("on", i < state.keys));
  if(state.keys === 5){
    els.statusText.textContent = "Unlocked. Desktop is secured.";
  }else{
    const next = STATIONS[state.currentIndex]?.title || "‚Äî";
    els.statusText.textContent = state.started
      ? `Next: ${next}. Complete stations to unlock.`
      : "Locked. Begin to start.";
  }
}

/* Station availability rules (sequential) */
function refreshAvailability(){
  STATIONS.forEach((st, idx)=>{
    const isDone = idx < state.keys;
    const isCurrent = idx === state.keys;
    if(isDone){
      setNodeLocked(st.key, false);
      setNodeState(st.key, "green");
    }else if(isCurrent){
      setNodeLocked(st.key, false);
      setNodeState(st.key, "red");
    }else{
      setNodeLocked(st.key, true);
      setNodeState(st.key, "red");
    }
  });

  const next = STATIONS[state.keys];
  if(next){
    setActiveNode(next.key);
    els.missionText.innerHTML = `Current target: <b>${next.title}</b>. Click the glowing station node to enter.`;
    els.subline.textContent = "Complete stations in order. Each completion gives one key fragment.";
  }
}

/* Pick questions per station */
function bankFor(stationKey){
  return QUESTION_BANK.filter(q => q.stationKey === stationKey);
}
function pickQuestion(stationKey){
  const pool = bankFor(stationKey);
  if(!pool.length) return null;

  // avoid immediate repetition by shuffling and selecting with rotation
  const shuffled = shuffle(pool);

  // return first; you can add stronger de-dup later by giving each question an id
  return structuredClone(shuffled[0]);
}

/* Shuffle options at runtime and re-map correct index */
function shuffleOptions(q){
  const opts = q.options.map((o, idx)=> ({...o, _orig: idx}));
  const shuffled = shuffle(opts);
  const newCorrect = shuffled.findIndex(o => o._orig === q.correctIndex);
  return {...q, options: shuffled.map(o=>({t:o.t, icon:o.icon})), correctIndex: newCorrect};
}

/* Station modal flow */
let currentQ = null;
let locked = false;

function openStation(stationKey){
  const idx = STATIONS.findIndex(s=>s.key===stationKey);
  if(idx !== state.keys) return; // enforce sequential

  state.activeStationKey = stationKey;
  state.stationCorrect = 0;

  const st = STATIONS[idx];
  els.mTitle.textContent = `${st.icon} ${st.title}`;
  els.mSub.textContent = st.subtitle + " ¬∑ Need 2 correct to secure";
  els.mCount.textContent = "0";

  // mock
  els.mockName.textContent = st.title;
  els.mockPath.textContent = st.path;
  els.a1k.textContent = "Status";
  els.a1v.textContent = st.facts.status;
  els.a2k.textContent = "Recommended";
  els.a2v.textContent = st.facts.recommended;
  els.a3k.textContent = "Impact";
  els.a3v.textContent = st.facts.impact;
  els.a4k.textContent = "Hint";
  els.a4v.textContent = st.facts.hint;

  els.pulse.className = "pulse";
  els.fb.className = "fb";
  els.stationModal.classList.add("show");
  els.stationModal.setAttribute("aria-hidden","false");

  nextQuestion();
}

function closeStation(){
  els.stationModal.classList.remove("show");
  els.stationModal.setAttribute("aria-hidden","true");
  currentQ = null;
  locked = false;
}

function renderQuestion(q){
  els.qText.textContent = q.q;
  els.opts.innerHTML = "";
  els.fb.className = "fb";

  q.options.forEach((o, i)=>{
    const btn = document.createElement("button");
    btn.type="button";
    btn.className="opt";
    btn.innerHTML = `
      <div class="l">
        <div class="ico" aria-hidden="true">${o.icon || "‚öôÔ∏è"}</div>
        <div style="font-weight:850;line-height:1.35">${o.t}</div>
      </div>
      <div class="kbd">${i+1}</div>
    `;
    btn.addEventListener("click", ()=> answer(i));
    els.opts.appendChild(btn);
  });
}

function nextQuestion(){
  const stationKey = state.activeStationKey;
  const q0 = pickQuestion(stationKey);
  if(!q0){
    // fallback if no questions
    currentQ = null;
    els.qText.textContent = "No questions found for this station. Please update the question bank.";
    els.opts.innerHTML = "";
    return;
  }
  currentQ = shuffleOptions(q0);
  renderQuestion(currentQ);
}

function setFeedback(ok){
  els.fb.className = "fb show " + (ok ? "good" : "bad");
  els.fbT.textContent = ok ? "Correct" : "Not quite";
  els.fbP.textContent = ok ? currentQ.ok : currentQ.bad;
  els.pulse.className = "pulse " + (ok ? "good" : "bad");
}

function lockOptions(v){
  Array.from(els.opts.querySelectorAll("button")).forEach(b=> b.disabled = v);
}

function answer(i){
  if(locked || !currentQ) return;
  locked = true;
  lockOptions(true);

  const ok = (i === currentQ.correctIndex);
  if(ok){
    state.stationCorrect += 1;
    els.mCount.textContent = String(state.stationCorrect);
    // node amber while in progress
    setNodeState(state.activeStationKey, "amber");
  }
  setFeedback(ok);

  // completion check
  if(ok && state.stationCorrect >= 2){
    els.nextBtn.textContent = "Secure Station";
  }else{
    els.nextBtn.textContent = "Next";
  }
}

function completeStation(){
  const idx = STATIONS.findIndex(s=>s.key===state.activeStationKey);
  // award key
  state.keys = clamp(state.keys + 1, 0, 5);
  state.currentIndex = state.keys;

  // visuals
  setNodeState(state.activeStationKey, "green");
  // unlock next node by refreshing availability
  updateTop();
  refreshAvailability();

  // spark animation to next if exists
  const next = STATIONS[state.keys];
  if(next){
    runSpark(STATIONS[state.keys-1].key, next.key);
  }

  // end if all keys
  if(state.keys === 5){
    closeStation();
    unlockDesktop();
  }else{
    closeStation();
  }
}

/* Unlock desktop */
function unlockDesktop(){
  // hide lock overlay and show end summary
  els.lockOverlay.classList.remove("show");
  els.endModal.classList.add("show");

  // end summary list
  els.endGrid.innerHTML = "";
  STATIONS.forEach(s=>{
    const row = document.createElement("div");
    row.className = "rowOk";
    row.innerHTML = `<div><b>${s.icon} ${s.title}</b><div style="color:var(--muted);font-size:12px;margin-top:2px">${s.subtitle}</div></div><div style="font-weight:950;color:rgba(61,220,151,.95)">‚úî</div>`;
    els.endGrid.appendChild(row);
  });
}

/* Buttons in station modal */
els.nextBtn.addEventListener("click", ()=>{
  if(!currentQ) return;

  // If station completed (2 correct), secure it
  if(state.stationCorrect >= 2){
    completeStation();
    return;
  }

  // normal next question
  locked = false;
  lockOptions(false);
  els.pulse.className = "pulse";
  els.fb.className = "fb";
  nextQuestion();
});

els.closeStationBtn.addEventListener("click", closeStation);

/* Click nodes */
Object.values(els.nodes).forEach(node=>{
  node.addEventListener("click", ()=>{
    if(!state.started) return;
    if(node.classList.contains("locked")) return;
    const key = node.dataset.key;
    openStation(key);
  });
});

/* Keyboard shortcuts (1‚Äì4) */
document.addEventListener("keydown", (e)=>{
  if(!els.stationModal.classList.contains("show")) return;
  const n = parseInt(e.key, 10);
  if(n>=1 && n<=4){
    const btn = els.opts.querySelectorAll("button")[n-1];
    if(btn && !btn.disabled) btn.click();
  }
});

/* How modal */
els.howBtn.addEventListener("click", ()=> els.howModal.classList.add("show"));
els.closeHowBtn.addEventListener("click", ()=> els.howModal.classList.remove("show"));

/* Begin + resets */
function start(){
  state.started = true;
  state.keys = 0;
  state.currentIndex = 0;
  state.stationCorrect = 0;
  state.activeStationKey = null;

  // initial states
  updateTop();
  refreshAvailability();
  layoutWires();

  els.lockOverlay.classList.remove("show");
  els.statusText.textContent = "Started. Click Accounts to begin.";
}
els.beginBtn.addEventListener("click", start);

function hardReset(){
  // Reset visuals and state
  state.started = false;
  state.keys = 0;
  state.currentIndex = 0;
  state.stationCorrect = 0;
  state.activeStationKey = null;

  // close modals
  els.stationModal.classList.remove("show");
  els.howModal.classList.remove("show");
  els.endModal.classList.remove("show");

  // restore lock overlay
  els.lockOverlay.classList.add("show");

  // node states
  STATIONS.forEach(st=>{
    setNodeLocked(st.key, true);
    setNodeState(st.key, "red");
  });
  setNodeLocked("accounts", false);

  updateTop();
  els.statusText.textContent = "Locked. Begin to start.";
  els.missionText.innerHTML = `Start with <b>Accounts</b>. Each station becomes available after the previous one is secured.`;
  els.subline.textContent = "Complete stations in order. Each station gives a key fragment.";
  setActiveNode("accounts");
  layoutWires();
}
els.resetBtn.addEventListener("click", hardReset);
els.resetTop.addEventListener("click", hardReset);

/* End modal buttons */
els.playAgainBtn.addEventListener("click", hardReset);
els.closeEndBtn.addEventListener("click", ()=> els.endModal.classList.remove("show"));

/* Initial UI */
(function init(){
  // lock all except accounts
  STATIONS.forEach(st=>{
    setNodeLocked(st.key, true);
    setNodeState(st.key, "red");
  });
  setNodeLocked("accounts", false);
  setActiveNode("accounts");
  updateTop();
  layoutWires();
})();
</script>
</body>
</html>
